!function(){"use strict";function t(t){var n=typeof t;return"function"===n||"object"===n&&!!t}function n(t){return Array.isArray(t)}function n(t){return"[object Array]"==toString.call(t)}function e(t){return"string"==typeof t||"[object String]"===toString.call(t)}function r(t){return!isNaN(Number(t))}function i(t){return 0==t||1==t}function o(t){return null==t}function c(t){return null!=t}function u(t,n){return c(t)?t:n}function a(t,n){for(var e=0,r=t.length;r>e&&n(t[e],e)!==!1;)e++;return t}function s(t){return"attrs["+t+"]"}function l(t,n){return r(t)?"Number("+s(n)+")":i(t)?"Boolean("+s(n)+" == true)":"String("+s(n)+")"}function f(t,e,r){var i=[];return 2==arguments.length?(t?n(t)?a(e,function(n,e){i.push(t[e]+"("+s(e)+")")}):a(e,function(t,n){i.push(l(t,n))}):a(e,function(t,n){i.push(s(n))}),i="return ["+i.join(",")+"]"):(t?n(t)?a(e,function(n,e){i.push('"'+r[e]+'": '+t[e]+"("+s(e)+")")}):a(e,function(t,n){i.push('"'+r[n]+'": '+l(t,n))}):a(e,function(t,n){i.push('"'+r[n]+'": '+s(n))}),i="return {"+i.join(",")+"}"),new Function("attrs",i)}function h(t,n){var e,r=0;return a(n,function(n){var i,o=n;-1!=p.indexOf(n)&&(o="\\"+o),i=t.match(new RegExp(o,"g")),i&&i.length>r&&(r=i.length,e=n)}),e||n[0]}var p=["|","^"],d=[",",";","	","|","^"],m=["\r\n","\r","\n"];Array.isArray;var g=function(){function r(t,r){if(r||(r={}),n(t))this.mode="encode";else{if(!e(t))throw new Error("Incompatible format!");this.mode="parse"}this.data=t,this.options={header:u(r.header,!1),cast:u(r.cast,!0)};var i=r.lineDelimiter||r.line,o=r.cellDelimiter||r.delimiter;this.isParser()?(this.options.lineDelimiter=i||h(this.data,m),this.options.cellDelimiter=o||h(this.data,d),this.data=c(this.data,this.options.lineDelimiter)):this.isEncoder()&&(this.options.lineDelimiter=i||"\r\n",this.options.cellDelimiter=o||",")}function i(t,n,e){t(new n(e))}function c(t,n){return t.slice(-n.length)!=n&&(t+=n),t}function s(r){return n(r)?"array":t(r)?"object":e(r)?"string":o(r)?"null":"primitive"}return r.prototype.set=function(t,n){return this.options[t]=n},r.prototype.isParser=function(){return"parse"==this.mode},r.prototype.isEncoder=function(){return"encode"==this.mode},r.prototype.parse=function(t){function e(){s={escaped:!1,quote:!1,cell:!0}}function r(){g.cell=""}function o(){g.line=[]}function c(t){g.line.push(s.escaped?t.slice(1,-1).replace(/""/g,'"'):t),r(),e()}function u(t){c(t.slice(0,1-d.lineDelimiter.length))}function a(){m?n(m)?(l=f(d.cast,g.line,m),(a=function(){i(t,l,g.line)})()):m=g.line:(l||(l=f(d.cast,g.line)),(a=function(){i(t,l,g.line)})())}if("parse"==this.mode){if(0===this.data.trim().length)return[];var s,l,h,p=this.data,d=this.options,m=d.header,g={cell:"",line:[]};t||(h=[],t=function(t){h.push(t)}),e(),1==d.lineDelimiter.length&&(u=c);var y,v,A,j=p.length,w=d.cellDelimiter.charCodeAt(0),D=d.lineDelimiter.charCodeAt(d.lineDelimiter.length-1);for(y=0,v=0;j>y;y++)A=p.charCodeAt(y),s.cell&&(s.cell=!1,34==A)?s.escaped=!0:s.escaped&&34==A?s.quote=!s.quote:(s.escaped&&s.quote||!s.escaped)&&(A==w?(c(g.cell+p.slice(v,y)),v=y+1):A==D&&(u(g.cell+p.slice(v,y)),v=y+1,a(),o()));return h?h:this}},r.prototype.serialize={object:function(t){var n=this,e=Object.keys(t),r=Array(e.length);return a(e,function(e,i){r[i]=n[s(t[e])](t[e])}),r},array:function(t){var n=this,e=Array(t.length);return a(t,function(t,r){e[r]=n[s(t)](t)}),e},string:function(t){return'"'+String(t).replace(/"/g,'""')+'"'},"null":function(){return""},primitive:function(t){return t}},r.prototype.encode=function(t){function e(t){return t.join(c.cellDelimiter)}if("encode"==this.mode){if(0==this.data.length)return"";var r,i,o=this.data,c=this.options,u=c.header,l=o[0],f=this.serialize,h=0;t||(i=Array(o.length),t=function(t,n){i[n+h]=t}),u&&(n(u)||(r=Object.keys(l),u=r),t(e(f.array(u)),0),h=1);var p,d=s(l);return"array"==d?(n(c.cast)?(p=Array(c.cast.length),a(c.cast,function(t,n){p[n]=t.toLowerCase()})):(p=Array(l.length),a(l,function(t,n){p[n]=s(t)})),a(o,function(n,r){var i=Array(p.length);a(n,function(t,n){i[n]=f[p[n]](t)}),t(e(i),r)})):"object"==d&&(r=Object.keys(l),n(c.cast)?(p=Array(c.cast.length),a(c.cast,function(t,n){p[n]=t.toLowerCase()})):(p=Array(r.length),a(r,function(t,n){p[n]=s(l[t])})),a(o,function(n,i){var o=Array(r.length);a(r,function(t,e){o[e]=f[p[e]](n[t])}),t(e(o),i)})),i?i.join(c.lineDelimiter):this}},r.prototype.forEach=function(t){return this[this.mode](t)},r}();g.parse=function(t,n){return new g(t,n).parse()},g.encode=function(t,n){return new g(t,n).encode()},g.forEach=function(t,n,e){return 2==arguments.length&&(e=n),new g(t,n).forEach(e)},"function"==typeof define&&define.amd?define("CSV",[],function(){return g}):"object"==typeof module&&module.exports?module.exports=g:window&&(window.CSV=g)}();
