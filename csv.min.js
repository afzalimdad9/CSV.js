(function(){"use strict";var e=typeof define==="function"&&define.amd,t=typeof module==="object"&&module.exports;var n=function(e){return!!(e&&e!==null)},i=/^(\-|\+)?([0-9]+(\.[0-9]+)?|Infinity)$/,o=function(e){e=e.toLowerCase();return e==="true"||e==="false"};var r=function(e,t,n){var r="return ",s=0,l=function(e,t){if(i.test(e)){return"Number(values["+t+"]),"}else if(o(e)){return"values["+t+"].toLowerCase() === 'true',"}else{return"values["+t+"],"}};if(e==="object"){r+="{";for(s=0;s<t.length;++s)r+='"'+t[s]+'": '+l(n[s],s);r=r.slice(0,-1)+"}"}else{r+="[";for(s=0;s<t.length;++s)r+=l(t[s],s);r=r.slice(0,-1)+"]"}return new Function("values",r)};var CSV=function(e,t){t=n(t)?t:{};this.options={line:n(t.line)?t.line:"\r\n",delimiter:n(t.delimiter)?t.delimiter:",",header:n(t.header)?t.header:false,done:n(t.done)?t.done:undefined};this.action=e instanceof Array?"encode":"parse";this.data=e;var i=this.options.line,o=i.length-1,r=e.length-1,s=function(e,t){return e.charCodeAt(t)};if(this.action==="parse"&&s(e,r)!==s(i,o)){this.data+=i}return this};CSV.prototype.set=function(e,t){this.options[e]=t;return this};CSV.prototype.encode=function(e){if(this.data.length===0)return"";var t=this.data,n=[],o=this.options.delimiter,r=t[0]instanceof Array?"array":"object",s=this.options.header,l=this.options.done,a=function(e){return i.test(e)?e:'"'+e.replace(/\"/g,'""')+'"'},c=e?function(t){e(t.join(o))}:function(e){n.push(e.join(o))},f=t.length,u,h,d,p,w,g;if(r==="object"){d=Object.keys(t[0]);p=d.length}else{p=t[0].length}g=new Array(p);if(s){var y=s instanceof Array?s:d;for(h=0;h<p;++h)g[h]=a(y[h]);c(g)}if(r==="object"){for(u=0;u<f;++u){w=t[u];for(h=0;h<p;++h)g[h]=a(w[d[h]]);c(g)}}else{for(u=0;u<f;++u){w=t[u];for(h=0;h<p;++h)g[h]=a(w[h]);c(g)}}n=n.join(this.options.line);if(l)l(n);return n};CSV.prototype.parse=function(e){if(this.data.trim().length===0)return[];var t=this.data,n=[],i=this.options.done,o=this.options.header,s=o instanceof Array?o:[],l=s.length,a={row:[],cell:""},c={escaped:false,quote:false,cell:true},f,u=function(e){a.row.push((c.escaped?e.slice(1,-1).replace(/""/g,'"'):e).trim());a.cell="";c={escaped:false,quote:false,cell:true}},h=e?function(){e(new f(a.row))}:function(){n.push(new f(a.row))},d=function(){if(o){if(l){f=new r("object",s,a.row);h();d=h}else{s=a.row,l=s.length}}else{if(!f)f=new r("array",a.row);h();d=h}},p,w,g=t.length,y=this.options.line.charCodeAt(this.options.line.length-1),v=this.options.delimiter.charCodeAt(0),m,j;for(p=0,w=0;w<=g;++w){m=t.charCodeAt(w-1);j=t.charCodeAt(w);if(c.cell){c.cell=false;if(j===34){c.escaped=true;continue}}if(c.escaped&&j===34){c.quote=!c.quote;continue}if(c.escaped&&c.quote||!c.escaped){if(j===v){u(a.cell+t.slice(p,w));p=w+1}else if(j===y){if(m<33){u((a.cell+t.slice(p,w)).slice(0,-1))}else{u(a.cell+t.slice(p,w))}p=w+1;d();a.row=[]}}}if(i)i(n);return n};CSV.prototype.forEach=function(e){return this[this.action](e)};if(e){define(CSV)}else if(t){module.exports=CSV}else{this.CSV=CSV}}).call(this);