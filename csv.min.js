(function(){"use strict";var e=function(e){return"undefined"!=typeof e},t=/^(\-|\+)?([0-9]+(\.[0-9]+)?|Infinity)$/,n=function(e){return e=e.toLowerCase(),"true"===e||"false"===e},o=function(e,o,i,r){var s,a="return ",c=r?function(e,o){return t.test(e)?"Number(values["+o+"]),":n(e)?"Boolean(values["+o+"].toLowerCase() === 'true'),":"String(values["+o+"]),"}:function(e,t){return"values["+t+"],"};if("object"===e){for(a+="{",s=0;s<o.length;++s)a+='"'+o[s]+'": '+c(i[s],s);a=a.slice(0,-1)+"}"}else{for(a+="[",s=0;s<o.length;++s)a+=c(i[s],s);a=a.slice(0,-1)+"]"}return new Function("values",a)},i=function(t,n){if(n=e(n)?n:{},this.options={async:e(n.async)?n.async:!1,cast:e(n.cast)?n.cast:!0,line:e(n.line)?n.line:"\r\n",delimiter:e(n.delimiter)?n.delimiter:",",header:e(n.header)?n.header:!1,done:e(n.done)?n.done:void 0},this.data=t,this.data instanceof Array)return this;for(var o=0;o<this.options.line.length;o++){var i=t.charCodeAt(t.length-this.options.line.length+o),r=this.options.line.charCodeAt(o);i!=r&&(this.data+=this.options.line.charAt(o))}return this};i.prototype.set=function(e,t){return this.options[e]=t,this},i.prototype.encode=function(e){if(0===this.data.length)return"";var t,n,o,i,r,s,a=this.data,c=[],l=this.options.delimiter,h=a[0]instanceof Array?"array":"object",u=this.options.header,f=this.options.done,d=function(e){return e?"string"!=typeof e?e:'"'+e.replace(/\"/g,'""')+'"':null},p=e?function(t){e(t.join(l))}:function(e){c.push(e.join(l))},w=a.length;if("object"===h?(o=Object.keys(a[0]),i=o.length):i=a[0].length,s=new Array(i),u){var y=u instanceof Array?u:o;for(n=0;i>n;++n)s[n]=d(y[n]);p(s)}if("object"===h)for(t=0;w>t;++t){for(r=a[t],n=0;i>n;++n)s[n]=d(r[o[n]]);p(s)}else for(t=0;w>t;++t){for(r=a[t],n=0;i>n;++n)s[n]=d(r[n]);p(s)}return c=c.join(this.options.line),f&&f(c),c},i.prototype.parse=function(e){if(0===this.data.trim().length)return[];var t,n,i,r,s=this.data,a=[],c=this.options.done,l=this.options.cast,h=this.options.header,u=h instanceof Array?h:[],f=this.options.line,d=u.length,p={row:[],cell:""},w={escaped:!1,quote:!1,cell:!0},y=function(e){p.row.push((w.escaped?e.slice(1,-1).replace(/""/g,'"'):e).trim()),p.cell="",w={escaped:!1,quote:!1,cell:!0}},g=1===f.length?y:function(e){y(e.slice(0,1-f.length))},v=e?function(){e(new t(p.row))}:function(){a.push(new t(p.row))},m=function(){h?d?(t=new o("object",u,p.row,l),v(),m=v):(u=p.row,d=u.length):(t||(t=new o("array",p.row,p.row,l)),v(),m=v)},A=s.length,j=f.charCodeAt(f.length-1),b=this.options.delimiter.charCodeAt(0);for(n=0,i=0;A>=i;++i)r=s.charCodeAt(i),w.cell&&(w.cell=!1,34===r)?w.escaped=!0:w.escaped&&34===r?w.quote=!w.quote:(w.escaped&&w.quote||!w.escaped)&&(r===b?(y(p.cell+s.slice(n,i)),n=i+1):r===j&&(g(p.cell+s.slice(n,i)),n=i+1,m(),p.row=[]));return c&&c(a),a},i.prototype.forEach=function(e){return this.data instanceof Array?this.encode(e):this.parse(e)},"function"==typeof define&&define.amd?define(function(){return i}):"object"==typeof module&&module.exports?module.exports=i:window&&this===window&&(this.CSV=i)}).call(this);